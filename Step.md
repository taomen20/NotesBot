# План разработки чат-бота для записок на молитву

## Технологический стек
- Python 3.10+
- aiogram 3.x (async фреймворк для Telegram)
- PostgreSQL (база данных)
- SQLAlchemy (ORM)
- YooKassa SDK (платежный шлюз)
- python-dotenv (конфигурация)

## Структура проекта (монолитное приложение)

```
NotesBot/
├── main.py                 # Точка входа, настройка webhook
├── config.py               # Конфигурация приложения
├── database.py             # Подключение к БД, создание таблиц
├── models.py               # SQLAlchemy модели
├── handlers/               # Обработчики команд и сообщений
│   ├── __init__.py
│   ├── user_handlers.py    # Обработчики для обычных пользователей
│   ├── priest_handlers.py  # Обработчики для священника/алтарника
│   └── admin_handlers.py   # Обработчики для администратора
├── services/               # Бизнес-логика
│   ├── __init__.py
│   ├── note_service.py     # Работа с записками
│   ├── payment_service.py  # Интеграция с Яндекс.Кассой
│   ├── user_service.py     # Управление пользователями и ролями
│   └── logging_service.py  # Журналирование операций
├── keyboards.py            # Клавиатуры для Telegram
├── utils.py                # Вспомогательные функции
├── .env.example            # Пример файла с переменными окружения
├── requirements.txt        # Зависимости
└── logs/                   # Директория для логов
```

## Шаги разработки

### Шаг 1: Инициализация проекта и зависимостей
- Создать структуру директорий
- Настроить requirements.txt с зависимостями
- Создать .env.example с необходимыми переменными
- Настроить config.py для загрузки конфигурации

### Шаг 2: Проектирование схемы базы данных
- Таблица users (id, telegram_id, username, role, created_at)
- Таблица notes (id, user_id, type, status, payment_id, amount, created_at, read_at)
- Таблица note_names (id, note_id, name, list_type)
- Таблица settings (key, value)
- Создать database.py с инициализацией БД и миграциями

### Шаг 3: Реализация моделей данных (SQLAlchemy)
- Модель User с ролями (USER, PRIEST, ALTAR_SERVER, ADMIN)
- Модель Note с типами (FOR_HEALTH, FOR_REPOSE) и статусами (PENDING, PAID, READ, DELETED)
- Модель NoteName для хранения имен
- Модель Setting для настроек системы

### Шаг 4: Настройка конфигурации
- Переменные окружения: токены Telegram, YooKassa, настройки БД
- Настройки по умолчанию: минимальная сумма, максимальное количество имен
- Реквизиты получателя для платежей

### Шаг 5: Базовый функционал Telegram бота
- Инициализация бота и диспетчера
- Настройка webhook
- Базовые команды (/start, /help)
- Система состояний (FSM) для многошаговых диалогов

### Шаг 6: Функционал для обычных пользователей
- Создание списка "За здравие" (ввод имен с валидацией)
- Создание списка "Об упокоении" (ввод имен с валидацией)
- Ввод суммы пожертвования с проверкой минимума
- Просмотр созданных списков перед оплатой
- Редактирование списков

### Шаг 7: Интеграция с Яндекс.Кассой
- Создание платежа через YooKassa API
- Обработка webhook от YooKassa (подтверждение платежа)
- Сохранение записки в очередь после подтверждения платежа
- Обработка отмененных/неуспешных платежей

### Шаг 8: Интерфейс для священника/алтарника
- Команда просмотра количества записок в очереди
- Выбор типа записки для прочтения (За здравие/Об упокоении)
- Отображение записки с именами и молитвой
- Подтверждение прочтения записки
- Отправка уведомления пользователю о прочтении
- Удаление записки после подтверждения

### Шаг 9: Интерфейс администратора
- Просмотр статистики (количество записок в очереди)
- Управление ролями пользователей (назначение священников/алтарников)
- Просмотр активности священников/алтарников (последнее время получения записок)
- Управление настройками системы

### Шаг 10: Система логирования
- Создание logging_service.py
- Логирование операций без персональных данных:
  - Создание записок (без имен)
  - Платежи (суммы, статусы)
  - Прочтение записок (тип, время)
  - Изменение ролей
- Сохранение в текстовые файлы с ротацией

### Шаг 11: Обработка ошибок и валидация
- Валидация ввода имен (ограничение длины, запрет спецсимволов)
- Обработка ошибок платежного шлюза
- Обработка ошибок БД
- Retry логика для критичных операций

### Шаг 12: Документация и развертывание
- README с инструкциями по установке
- Настройка переменных окружения
- Инструкции по развертыванию webhook
- Примеры использования

## Ключевые файлы для реализации

**main.py**: Инициализация бота, настройка webhook, запуск приложения
**database.py**: Подключение к PostgreSQL, создание таблиц через SQLAlchemy
**models.py**: Определение всех моделей данных с отношениями
**handlers/user_handlers.py**: FSM состояния для создания записок, обработка платежей
**handlers/priest_handlers.py**: Логика работы священника с очередью записок
**handlers/admin_handlers.py**: Административные команды
**services/payment_service.py**: Интеграция с YooKassa API, создание и проверка платежей
**services/note_service.py**: CRUD операции с записками, работа с очередью
**services/logging_service.py**: Централизованное логирование операций

